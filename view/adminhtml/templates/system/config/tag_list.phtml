<?php
/**
 * Copyright (c) 2025. Volodymyr Hryvinskyi. All rights reserved.
 * Author: Volodymyr Hryvinskyi <volodymyr@hryvinskyi.com>
 * GitHub: https://github.com/hryvinskyi
 */

declare(strict_types=1);

/**
 * @var $block \Magento\Framework\View\Element\Template
 * @var $element \Magento\Framework\Data\Form\Element\AbstractElement
 * @var $config array
 */

$element = $block->getData('element');
$config = $block->getData('config');
$inputId = $element->getHtmlId();
$inputName = $element->getName();
$inputValue = $element->getValue();
$disabled = $element->getCanUseWebsiteValue()
    || $element->getCanUseDefaultValue()
    || $element->getCanRestoreToDefault();

// Parse current values based on save type
$separator = $config['separator'] ?? "\n";
$saveType = $config['save_type'] ?? 'separator';
$values = [];

if ($inputValue !== null && $inputValue !== '') {
    switch ($saveType) {
        case 'json':
            $decoded = json_decode((string) $inputValue, true);
            $values = is_array($decoded) ? array_values(array_filter($decoded)) : [];
            break;

        case 'serialized':
            try {
                // @codingStandardsIgnoreLine
                $unserialized = @unserialize((string) $inputValue);
                $values = is_array($unserialized) ? array_values(array_filter($unserialized)) : [];
            } catch (\Exception $e) {
                $values = [];
            }
            break;

        case 'separator':
        default:
            $values = array_values(array_filter(array_map('trim', explode($separator, (string) $inputValue))));
            break;
    }
}


$valuesJson = json_encode($values, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP);
?>

<div class="tag-list-root" id="tag-list-<?= $block->escapeHtmlAttr($inputId) ?>">
    <div class="tag-list-container<?= $disabled ? ' tag-list-disabled' : '' ?>"
         id="tag-list-container-<?= $block->escapeHtmlAttr($inputId) ?>">
        <input type="text"
               class="tag-list-input"
               id="tag-list-input-<?= $block->escapeHtmlAttr($inputId) ?>"
               placeholder="<?= $block->escapeHtmlAttr($config['placeholder']) ?>"
               <?= $disabled ? 'disabled' : '' ?>>
    </div>

    <input type="hidden"
           id="<?= $block->escapeHtmlAttr($inputId) ?>"
           name="<?= $block->escapeHtmlAttr($inputName) ?>"
           value="<?= $block->escapeHtmlAttr($inputValue) ?>">
</div>

<script type="text/x-magento-init">
    {
        "#tag-list-<?= $block->escapeJs($inputId) ?>": {
            "Hryvinskyi_ConfigurationFields/js/tag-list": {
                "inputId": "<?= $block->escapeJs($inputId) ?>",
                "values": <?= /* @noEscape */ $valuesJson ?>,
                "validation": "<?= $block->escapeJs($config['validation']) ?>",
                "validationMessage": "<?= $block->escapeJs($config['validation_message'] ?? '') ?>",
                "uppercase": <?= $config['uppercase'] ? 'true' : 'false' ?>,
                "separator": <?= json_encode($config['separator']) ?>
            }
        }
    }
</script>
